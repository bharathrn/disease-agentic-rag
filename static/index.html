<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Disease → Treatment Finder</title>
  <style>
    /* Soft modern dark theme */
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --muted:#94a3b8;
      --accent:#7c3aed;
      --accent-2:#06b6d4;
      --glass: rgba(255,255,255,0.03);
      --glass-2: rgba(255,255,255,0.02);
      --success: #10b981;
      --danger: #ef4444;
      --radius: 12px;
      color-scheme: dark;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{
      height:100%;
      margin:0;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(124,58,237,0.10), transparent),
                  linear-gradient(180deg, rgba(6,182,212,0.02), rgba(255,255,255,0.01));
      background-color:var(--bg);
      color: #e6eef8;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .container{
      max-width:1000px;
      margin:48px auto;
      padding:28px;
      display:grid;
      grid-template-columns: 1fr 380px;
      gap:24px;
    }

    /* Card */
    .card{
      background: linear-gradient(180deg,var(--glass), var(--glass-2));
      border-radius:var(--radius);
      padding:20px;
      box-shadow: 0 6px 30px rgba(2,6,23,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.03);
    }

    header h1{ margin:0; font-size:20px; letter-spacing:-0.2px; }
    header p { margin:8px 0 0; color:var(--muted); font-size:13px }

    /* Input area */
    label{ display:block; font-size:13px; color:var(--muted); margin-bottom:8px; }
    textarea{
      width:100%;
      resize:vertical;
      min-height:110px;
      max-height:260px;
      background:transparent;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.04);
      padding:12px 14px;
      color:inherit;
      font-size:14px;
      outline:none;
      box-shadow: none;
    }
    .controls{ display:flex; gap:10px; margin-top:12px; align-items:center; }
    .btn{
      background: linear-gradient(90deg,var(--accent), #5b21b6);
      border: none;
      color:white;
      padding:10px 14px;
      border-radius:10px;
      font-weight:600;
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(124,58,237,0.18);
    }
    .btn.secondary{
      background:transparent;
      border:1px solid rgba(255,255,255,0.04);
      color:var(--muted);
      padding:8px 12px;
      font-weight:600;
    }
    .small{ font-size:13px; padding:8px 10px; border-radius:8px; }

    /* Right column */
    .meta{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .panel-title{
      font-size:13px;
      color:var(--muted);
      margin-bottom:8px;
    }

    /* Disease list */
    .diseases-list{ list-style:none; padding:0; margin:0; display:grid; gap:8px; }
    .disease-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 12px;
      border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
      border:1px solid rgba(255,255,255,0.02);
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .disease-item:hover{ transform:translateY(-4px); box-shadow: 0 10px 30px rgba(2,6,23,0.6); }
    .disease-name{ font-weight:600; }
    .disease-id{ color:var(--muted); font-size:12px; margin-left:8px; }

    /* Treatments modal (light themed) */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(255,255,255,0.75); /* light overlay */
      display:none; align-items:center; justify-content:center; z-index:100;
      padding:20px;
    }
    .modal{
      width:min(820px,96%);
      background: #ffffff;               /* white card */
      border-radius:14px;
      padding:20px;
      border:1px solid rgba(0,0,0,0.08);
      box-shadow: 0 12px 40px rgba(0,0,0,0.2);
      color: #222;                       /* dark text */
    }
    .modal h3{ margin:0 0 8px 0; color:#2a4365; }
    .modal .meta-row{ color:#4a5568; }

    .treat-list{
      list-style: disc;
      padding-left: 1.25rem;
      color:#333;
      margin: 0;
    }
    .treat-list li{
      margin: 8px 0;
      line-height: 1.55;
    }
    .treat-list li::marker{
      color: #3182ce; /* blue bullets */
    }

    /* Modal buttons for light theme */
    .modal .btn{
      background: linear-gradient(90deg,#3182ce,#2b6cb0);
      border: none;
      color: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(49,130,206,0.25);
    }
    .modal .btn.secondary{
      background:#f1f5f9;
      border:1px solid #cbd5e1;
      color:#334155;
    }

    /* utilities */
    .muted{ color:var(--muted); font-size:13px; }
    .note{ font-size:13px; color:#9fb6c9; margin-top:8px; }

    /* empty state */
    .empty{
      text-align:center;
      padding:28px;
      border-radius:10px;
      color:var(--muted);
      background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
      border:1px dashed rgba(255,255,255,0.02);
    }

    /* loader */
    .loader{
      border:4px solid rgba(255,255,255,0.06);
      border-left-color:var(--accent);
      width:22px;height:22px;border-radius:50%;
      animation:spin 0.9s linear infinite;
      display:inline-block; vertical-align:middle;
    }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    /* Footer */
    .disclaimer{ font-size:12px; color:var(--muted); margin-top:10px; }

    /* Responsive */
    @media (max-width:980px){
      .container{ grid-template-columns: 1fr; margin:20px; padding:20px; }
      .meta{ order:2; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card" style="min-height:420px;">
      <header>
        <h1>Disease → Treatment Finder</h1>
        <p>Type symptoms (short or detailed). Click a disease to see suggested treatments. A clinician should review before acting.</p>
      </header>

      <div style="margin-top:18px;">
        <label for="symptoms">Describe symptoms</label>
        <textarea id="symptoms" placeholder="e.g. infantile seizures, hypotonia, developmental delay"></textarea>

        <div class="controls">
          <button id="searchBtn" class="btn">Search Diseases</button>
          <button id="clearBtn" class="btn secondary small">Clear</button>
          <div style="flex:1"></div>
          <div id="status" class="muted" aria-live="polite"></div>
        </div>

        <p class="note">Tip: be specific when possible. You can click a disease on the right to view suggested treatments.</p>

        <div style="margin-top:18px;">
          <div class="panel-title">Search history</div>
          <div id="historyWrap" class="empty">No previous searches yet</div>
        </div>

        <p class="disclaimer">⚠️ This system provides suggested treatments for engineering/testing only. Clinical decisions must be made by qualified clinicians.</p>
      </div>
    </div>

    <aside class="meta">
      <div class="card">
        <div class="panel-title">Possible diseases</div>
        <div id="diseasesArea">
          <div class="empty">Search symptoms to see candidate diseases.</div>
        </div>
      </div>

      <div class="card">
        <div class="panel-title">Quick actions</div>
        <div style="display:flex; gap:10px; flex-direction:column;">
          <button id="refreshBtn" class="btn secondary small">Refresh last result</button>
          <button id="copyBtn" class="btn secondary small">Copy top treatments</button>
          <button id="exportBtn" class="btn small" style="background:linear-gradient(90deg,var(--accent-2),#0891b2)">Export</button>
        </div>
        <p class="muted" style="margin-top:10px;">Backend endpoints used: <code>/get_diseases</code> and <code>/get_treatments</code></p>
      </div>
    </aside>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <h3 id="modalTitle">Treatments</h3>
          <div id="modalSubtitle" class="muted">Disease: <span id="modalDisease"></span></div>
        </div>
        <div>
          <button id="closeModal" class="btn secondary small">Close</button>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div class="meta-row">
          <div class="muted">Source: RAG</div>
          <div style="flex:1"></div>
          <!-- <div class="muted">Confidence: <span id="modalConfidence">—</span></div> -->
        </div>

        <ol id="treatmentList" class="treat-list"></ol>

        <div style="display:flex; gap:8px; margin-top:14px;">
          <button id="approveBtn" class="btn">Request clinician review</button>
          <button id="copyTreat" class="btn secondary small">Copy</button>
          <button id="shareBtn" class="btn secondary small">Share</button>
        </div>

        <p class="note" style="margin-top:12px;">When ready, you can send these suggestions to a clinician for approval. Approved/edited results should be returned to the user.</p>
      </div>
    </div>
  </div>

  <script>
    // --- Config: API endpoints ---
    const API_BASE = location.hostname === 'localhost' ? 'http://localhost:8000' : ''; // adapt if deployed
    const GET_DISEASES = API_BASE + '/get_diseases';
    const GET_TREATMENTS = API_BASE + '/get_treatments';

    // --- UI refs ---
    const symptomsEl = document.getElementById('symptoms');
    const searchBtn = document.getElementById('searchBtn');
    const clearBtn = document.getElementById('clearBtn');
    const diseasesArea = document.getElementById('diseasesArea');
    const statusEl = document.getElementById('status');
    const historyWrap = document.getElementById('historyWrap');
    const refreshBtn = document.getElementById('refreshBtn');
    const modal = document.getElementById('modal');
    const modalDisease = document.getElementById('modalDisease');
    const treatmentList = document.getElementById('treatmentList');
    const closeModal = document.getElementById('closeModal');
    const approveBtn = document.getElementById('approveBtn');
    const copyTreat = document.getElementById('copyTreat');
    const copyBtn = document.getElementById('copyBtn');
    const exportBtn = document.getElementById('exportBtn');
    const shareBtn = document.getElementById('shareBtn');
    // const modalConfidence = document.getElementById('modalConfidence');

    // --- App state ---
    let lastDiseases = [];
    let lastQuery = '';
    let lastTreatments = [];
    let lastDiseaseName = '';

    function setStatus(text, loading = false) {
      statusEl.innerHTML = loading ? '<span class="loader"></span> ' + text : text;
    }

    function setEmptyDiseases() {
      diseasesArea.innerHTML = '<div class="empty">Search symptoms to see candidate diseases.</div>';
    }

    function renderDiseases(list) {
      if (!list || list.length === 0) {
        diseasesArea.innerHTML = '<div class="empty">No candidate diseases found.</div>';
        return;
      }
      const ul = document.createElement('ul');
      ul.className = 'diseases-list';
      list.forEach(item => {
        const li = document.createElement('li');
        li.className = 'disease-item';
        li.tabIndex = 0;
        li.innerHTML = `<div><div class="disease-name">${escapeHtml(item.name)}</div><div class="disease-id">${escapeHtml(item.disease_id || '')}</div></div>
                        <div class="muted">View</div>`;
        li.addEventListener('click', () => onDiseaseClick(item));
        li.addEventListener('keydown', (e) => { if (e.key === 'Enter') onDiseaseClick(item); });
        ul.appendChild(li);
      });
      diseasesArea.innerHTML = '';
      diseasesArea.appendChild(ul);
    }

    // --- Helpers ---
    function escapeHtml(s){ return (s||'').replace(/[&<>"'`]/g, (c)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;",'`':'&#96;'}[c])); }

    // --- API calls ---
    async function postJson(url, body){
      const res = await fetch(url, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(body)
      });
      if (!res.ok){
        const err = await res.json().catch(()=>({detail:res.statusText}));
        throw new Error(err.detail || 'API error');
      }
      return res.json();
    }

    async function searchDiseases(){
      const q = symptomsEl.value.trim();
      if (!q) { setStatus('Please type symptoms to search.'); return; }
      setStatus('Searching...', true);
      try {
        const data = await postJson(GET_DISEASES, { symptoms: q });
        lastDiseases = data.diseases || [];
        lastQuery = q;
        renderDiseases(lastDiseases);
        updateHistory(q, lastDiseases);
        setStatus(`Found ${lastDiseases.length} candidate(s).`);
      } catch (err) {
        setStatus('Error: ' + err.message);
        diseasesArea.innerHTML = `<div class="empty">Error: ${escapeHtml(err.message)}</div>`;
      }
    }

    async function onDiseaseClick(item){
      // call treatments API
      setStatus('Fetching treatments...', true);
      try {
        const data = await postJson(GET_TREATMENTS, { disease: item.name });
        debugger;
        const treatments = data.treatments || [];
        lastTreatments = treatments;
        lastDiseaseName = item.name;
        showModal(item.name, treatments);
        setStatus('Treatments retrieved.');
      } catch (err) {
        setStatus('Error: ' + err.message);
      }
    }

    // --- Modal controls ---
    function showModal(diseaseName, treatments){
      // Set title/subtitle
      modalDisease.textContent = diseaseName || "—";
      // modalConfidence.textContent = 'n/a';

      // Normalize treatments to an array of strings
      let items = [];
      if (Array.isArray(treatments)) {
        items = treatments;
      } else if (treatments && typeof treatments === 'object' && Array.isArray(treatments.treatments)) {
        items = treatments.treatments;
      } else if (typeof treatments === 'string') {
        // Split on newlines or semicolons if a single string came back
        items = treatments.split(/\n|;+/).map(s => s.trim()).filter(Boolean);
      }

      // Render bullet list
      treatmentList.innerHTML = '';
      if (items.length === 0) {
        const li = document.createElement('li');
        li.textContent = 'No suggested treatments found.';
        treatmentList.appendChild(li);
      } else {
        const frag = document.createDocumentFragment();
        items.forEach(t => {
          const li = document.createElement('li');
          li.textContent = t.treatments.join(" | ");
          frag.appendChild(li);
        });
        treatmentList.appendChild(frag);
      }

      // Open modal
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');
    }



    function hideModal(){ modal.style.display = 'none'; modal.setAttribute('aria-hidden','true'); }

    closeModal.addEventListener('click', hideModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) hideModal(); });

    // --- History ---
    function updateHistory(query, diseases){
      const row = document.createElement('div');
      row.style.padding = '8px';
      row.style.borderTop = '1px solid rgba(255,255,255,0.02)';
      row.innerHTML = `<div style="font-weight:600">${escapeHtml(query)}</div>
                       <div class="muted" style="margin-top:6px">${(diseases||[]).slice(0,3).map(d=>escapeHtml(d.name)).join(' • ')}</div>`;
      if (historyWrap.classList && historyWrap.classList.contains('empty')) historyWrap.innerHTML = '';
      historyWrap.prepend(row);
    }

    // --- Copy & Export helpers ---
    copyTreat.addEventListener('click', async () => {
      if (!lastTreatments || lastTreatments.length === 0) return;
      await navigator.clipboard.writeText(lastTreatments.join('\n'));
      setStatus('Treatments copied to clipboard.');
    });

    copyBtn.addEventListener('click', async () => {
      if (!lastTreatments || lastTreatments.length === 0) return;
      await navigator.clipboard.writeText(lastTreatments.join('\n'));
      setStatus('Top treatments copied.');
    });

    exportBtn.addEventListener('click', () => {
      const payload = { query: lastQuery, disease: lastDiseaseName, treatments: lastTreatments, timestamp: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(payload,null,2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'treatments_export.json'; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      setStatus('Exported results as JSON.');
    });

    shareBtn.addEventListener('click', () => {
      const shareText = `Treatments for ${lastDiseaseName}:\n\n${lastTreatments.join('\n')}`;
      if (navigator.share) {
        navigator.share({ title: `Treatments — ${lastDiseaseName}`, text: shareText }).catch(()=>setStatus('Share cancelled.'));
      } else {
        navigator.clipboard.writeText(shareText).then(()=> setStatus('Copied share text to clipboard.'));
      }
    });

    // --- Misc controls ---
    searchBtn.addEventListener('click', searchDiseases);
    clearBtn.addEventListener('click', () => { symptomsEl.value=''; setEmptyDiseases(); setStatus('Cleared.'); });
    refreshBtn.addEventListener('click', () => { if (lastQuery) { symptomsEl.value = lastQuery; searchDiseases(); } else setStatus('Nothing to refresh.'); });

    // keyboard: enter while textarea with Ctrl+Enter to submit
    symptomsEl.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { searchDiseases(); }
    });

    // initialize
    setEmptyDiseases();
  </script>
</body>
</html>
